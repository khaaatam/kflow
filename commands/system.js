const fs = require('fs');
const path = require('path');

module.exports = async (client, msg, text, senderId, namaPengirim) => {
    const chatDestination = msg.fromMe ? msg.to : msg.from;

    // --- FITUR 1: CEK ID (!CEKID) ---
    if (text === '!cekid') {
        return client.sendMessage(chatDestination, `ðŸ†” ID Terdeteksi: \`${senderId}\`\nðŸ‘¤ User: ${namaPengirim || 'Gak Dikenal'}`);
    }

    if (text === '!ping') {
        return client.sendMessage(chatDestination, "Pong!");
    }

    // --- FITUR 2: MENU OTOMATIS (!HELP / !MENU) ---
    if (text === '!help' || text === '!menu') {
        let menuText = `ðŸ¤– *MENU BOT KEUANGAN & AI* ðŸ¤–\n_Auto-Generated by System_\n\n`;

        // 1. DAFTAR ICON SPESIAL (Daftarin DOWNLOADER di sini) ðŸŽ¨
        const categoryIcons = {
            'KEUANGAN': 'ðŸ’°',
            'AI': 'ðŸ§ ',
            'DOWNLOADER': 'ðŸ“¥',
            'EVENT': 'ðŸ—“ï¸',
            'SYSTEM': 'âš™ï¸',
            'LAINNYA': 'ðŸ“‚'
        };

        // 2. BACA SEMUA FILE DI FOLDER COMMANDS
        const commandFiles = fs.readdirSync(__dirname).filter(file => file.endsWith('.js'));
        const categories = {};

        for (const file of commandFiles) {
            try {
                const cmdModule = require(path.join(__dirname, file));
                if (cmdModule.metadata) {
                    const meta = cmdModule.metadata;
                    if (!categories[meta.category]) {
                        categories[meta.category] = [];
                    }
                    meta.commands.forEach(c => {
                        categories[meta.category].push(`- *${c.command}* : ${c.desc}`);
                    });
                }
            } catch (err) {
                console.error(`Gagal baca metadata ${file}:`, err);
            }
        }

        // 3. RAKIT TEXT MENU (Masukin DOWNLOADER ke urutan)
        const order = ['KEUANGAN', 'DOWNLOADER', 'AI', 'EVENT', 'SYSTEM', 'LAINNYA'];

        // Loop kategori prioritas
        order.forEach(cat => {
            if (categories[cat]) {
                const icon = categoryIcons[cat] || 'ðŸ“¦';
                menuText += `${icon} *${cat}*\n${categories[cat].join('\n')}\n\n`;
                delete categories[cat];
            }
        });

        // Loop sisanya (Kalo ada kategori nyasar)
        for (const cat in categories) {
            // ðŸ‘‡ Gw ganti 'Vs' jadi 'ðŸ“¦' biar lebih enak dipandang
            menuText += `ðŸ“¦ *${cat}*\n${categories[cat].join('\n')}\n\n`;
        }

        menuText += `_Gunakan dengan bijak ya Bang ${namaPengirim}!_ â˜•`;
        return client.sendMessage(chatDestination, menuText);
    }
};

// --- LABEL METADATA ---
module.exports.metadata = {
    category: "SYSTEM",
    commands: [
        { command: '!menu', desc: 'Tampilkan daftar ini' },
        { command: '!cekid', desc: 'Cek ID WhatsApp' }
    ]
};